###--------------------------------------------
### DEST : directory where to put binaries
### ARCH : faust architecture file

system	:= $(shell uname -s)
dspsrc  := $(wildcard *.dsp)
cppsrc  := $(addprefix $(DEST), $(dspsrc:.dsp=.cpp))


### check what type of applications to build (MacOSX Darwin or Linux)
ifeq ($(system), Darwin)
appls	:= $(addprefix $(DEST),  $(dspsrc:.dsp=.app))
SPEC	:= -spec macx-g++ ###macx-clang
else
appls	:= $(addprefix $(DEST),  $(dspsrc:.dsp=))
SPEC	:= 
endif
### --------------------------------------------


### allocate a unique directory
TDR := $(shell mktemp -d -t FAUST.XXXXXX)
TMP = $(TDR)/$(<:.dsp=)
### --------------------------------------------


all : $(appls)


### Darwin 
$(DEST)%.app : %.dsp
	install -d $(TMP)
	faust -i -a $(ARCH) $(VEC) $< -o $(TMP)/$<.cpp
	cd $(TMP); qmake -project "QT+=widgets printsupport network"  "$(DEFS)" "CONFIG+=warn_off" "CONFIG+=c++11" "INCLUDEPATH+=/usr/local/include/" "HEADERS+=/usr/local/include/faust/gui/faustqt.h" "LIBS+=$(LIB)" "QMAKE_CXXFLAGS= -O3 -mfpmath=sse -msse -msse2 -msse3 -ffast-math -ftree-vectorize -Wno-unused-parameter"
	cd $(TMP); qmake $(SPEC)
	make -C $(TMP)
	rm -rf $@
	mv $(TMP)/$(<:.dsp=.app) $(DEST)
	rm -rf $(TDR)


### Linux
hdir1 := $(wildcard /usr/local/include/faust/gui/faustqt.h)
hdir2 := $(wildcard /usr/share/faust/faustqt.h)
hdir3 := $(wildcard /usr/local/include/faust/faustqt.h)
hdir23 := $(if $(hdir2),$(dir $(hdir2)),$(dir $(hdir3)))
hdir := $(if $(hdir1),$(dir $(hdir1)),$(hdir23))
qm4 := $(shell which qmake-qt4)
qm := $(if $(qm4),$(qm4),qmake)

$(DEST)% : %.dsp
	rm -rf $(TMP)
	install -d $(TMP)
	faust -a $(ARCH) $(VEC) $< -o $(TMP)/$<.cpp
	cd $(TMP); $(qm) -project "QT += widgets printsupport" "$(DEFS)" "INCLUDEPATH+=/usr/local/include/faust/" "INCLUDEPATH+=/usr/local/include/faust/osclib" "LIBS+=$(LIB)" "HEADERS+=$(hdir)faustqt.h" 
	cd $(TMP); $(qm) $(SPEC)
	make -C $(TMP)
	mv $(TMP)/$(<:.dsp=) $@
	rm -rf $(TMP)

clean:
	rm -rf $(DEST)
